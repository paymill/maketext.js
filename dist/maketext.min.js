/*! maketext.js - v0.1.0 - 2014-01-09
* https://github.com/paymill/maketext.js
* Copyright (c) 2014 Matthias Dietrich / PAYMILL GmbH / Coma-systems Co. Ltd. */
"use strict";function Lit(a){this.str=String(a)}function Seq(a){this.seq=a||[]}function Ref(a){this.idx=Number(a)||0}function Call(a,b){this.name=String(a),this.args=b||[]}var maketext=function(a){a||(a={}),this._loadTimeout=a.loadTimeout||2e4,this._base_url=a.base_url||"",this._fallbackLanguages=a.fallbackLanguages||["*","i-default","en","en-US"],this._lexicons={},this._callbacks={},this._languages={};var b=a.languages;if(a.lexicons){var c;for(c in a.lexicons)this._languages[c]=!0;for(c in a.lexicons)this.lexicon(c,a.lexicons[c])}else{if(!(b instanceof Array&&0!==b.length))throw new Error("languages must not be empty");for(var d=0;d<b.length;d++)this._languages[b[d]]=!0}};maketext.prototype={_load:function(a,b,c){if("function"!=typeof b)throw new TypeError("`"+b+"' is not a function");if(arguments.length>=3&&"function"!=typeof c)throw new TypeError("`"+c+"' is not a function");if(this._lexicons.hasOwnProperty(a))return b();if(this._callbacks.hasOwnProperty(a))return this._callbacks[a].onSuccess.push(b),c&&this._callbacks[a].onError.push(c),void 0;var d=this;this._callbacks[a]={onSuccess:[b],onError:c?[c]:[],timer:setTimeout(function(){for(var b=d._callbacks[a].onError,c=0;c<b.length;c++)b[c]();delete d._callbacks[a]},this._loadTimeout)};var e=document.createElement("script");e.type="text/javascript",e.src=this._base_url+a+".js",(document.getElementsByTagName("head")[0]||document.body||document).appendChild(e)},lexicon:function(a,b,c){if("string"!=typeof b&&(c=b,b=null),b){var d=this;this._load(b,function(){d._lexicon_aux(a,this._cloneObject(d._lexicons[b]),c)},function(){throw new Error("Can't load lexicon file for `"+a+"'")})}else this._lexicon_aux(a,{},c)},_lexicon_aux:function(a,b,c){var d;for(d in c)c.hasOwnProperty(d)&&(b[d]=c[d]);if(this._lexicons[a]=b,this._callbacks.hasOwnProperty(a)){var e=this._callbacks[a];for(delete this._callbacks[a],clearTimeout(e.timer),d=0;d<e.onSuccess.length;d++)e.onSuccess[d]()}},getHandle:function(a){function b(){e(new maketext.Handle(g._lexicons[d]))}function c(){if("function"!=typeof f)throw new Error("Can't load lexicon file for `"+d+"'");f()}a=a||{};var d=this._resolve_lang(a.lang||navigator.language||navigator.browserLanguage),e=a.onSuccess,f=a.onError,g=this;this._load(d,b,c)},_resolve_lang:function(a){var b,c=String(a).match(/(\w+(?:-\w+)*)/g)||[];for(b=0;b<c.length;b++)if(this._languages.hasOwnProperty(c[b]))return c[b];for(b=0;b<c.length;b++){var d=String(c[b]).split(/-/);for(d.pop();d.length;){var e=d.join("-");if(this._languages.hasOwnProperty(e))return e;d.pop()}}for(c=this._fallbackLanguages,b=0;b<c.length;b++)if(this._languages.hasOwnProperty(c[b]))return c[b];throw new Error("No language to load was found for `"+a+"'")},_cloneObject:function(a){function b(){}return b.prototype=a,new b}},maketext.Handle=function(a){this._lexicon=a},maketext.Handle.prototype={maketext:function(a){"function"!=typeof this._lexicon[a]&&(this._lexicon[a]=this.compile(this._lexicon[a]));var b=Array.prototype.slice.call(arguments,1);return b.unshift(this),this._lexicon[a].apply(this,b)},quant:function(){var a="1"==arguments[1]?arguments[2]:arguments[3];return"0"==arguments[1]&&arguments[4]&&(a=arguments[4]),a=a.replace(/(_\d+)/g,"[$1]"),this.compile(a).apply(this,[this,arguments[1]])},compile:function(str){var ctx=new Parser(str).parse();return eval("0, function(){ return "+ctx.val.compile()+"; }")}},Lit.prototype.compile=function(){return'"'+this.str.replace(/(["\\\b\f\n\r\t\v\u2028\u2029])/g,function(a){switch(a){case"\b":return"\\b";case"\f":return"\\f";case"\n":return"\\n";case"\r":return"\\r";case"	":return"\\t";case"":return"\\v";case"\u2028":return"\\u2028";case"\u2029":return"\\u2029";default:return"\\"+a}})+'"'},Seq.prototype={add:function(){return this.seq.push.apply(this.seq,arguments)},concat:function(a){return new Seq(this.seq.concat(a.seq))},compile:function(){for(var a=[],b=0;b<this.seq.length;b++)a.push(this.seq[b].compile());return"["+a.join(",")+"].join('')"}},Ref.prototype.compile=function(){return this.idx<0?"arguments[arguments.length + "+this.idx+"]":"arguments["+this.idx+"]"},Call.prototype={add:function(){this.args.push.apply(this.args,arguments)},compile:function(){for(var a=["this"],b=0;b<this.args.length;b++)a.push(this.args[b].compile());return"this."+this.name+"("+a.join(",")+")"}};var Parser=function(a,b,c){this.str=String(a),this.pos=Number(b)||0,this.val=c};Parser.prototype={toString:function(){return this.str.slice(0,this.pos)+" <-- HERE --> "+this.str.slice(this.pos)},error:function(a){throw new SyntaxError(a+": "+this.toString())},isEOS:function(){return this.pos>=this.str.length},stepTo:function(a){return new Parser(this.str,Number(a)||0,this.val)},stepBy:function(a){return new Parser(this.str,this.pos+Number(a)||0,this.val)},charAt:function(a){return a=Number(a),isNaN(a)&&(a=this.pos),this.str.charAt(a)},value:function(a){return new Parser(this.str,this.pos,a)},match:function(a){a instanceof RegExp||(a=new RegExp(a,"g")),a.lastIndex=this.pos;var b=a.exec(this.str);return b?this.stepBy(b[0].length).value(b):this.value(b)},parse:function(){for(var a=new Seq,b=this;!b.isEOS();){b=b.match(/[^\[~]*(?:~[\[\],~]?[^\[~]*)*/g);var c=b.val[0];c&&a.add(new Lit(this.unescape(c))),b=b.parse_bracket(),b.val&&a.add(b.val)}return b.value(a)},parse_bracket:function(){if("["!==this.charAt())return this.value(null);var a=this.stepBy(1);a=a.parse_method();for(var b=a.val;","===a.charAt();)a=a.stepBy(1).parse_arg(),b.add(a.val);return"]"!==a.charAt()&&this.error("unmatched `['"),a=a.stepBy(1),b instanceof Seq&&0===b.seq.length?a.value(null):a.value(b)},parse_method:function(){var a=this.match(/_(-?\d+)|_\*|\*|\#|[a-zA-Z_$]\w*|/g),b=a.val;switch(a.str.charAt(a.pos)){case",":case"]":break;default:a.error("unknown context")}if(b[1])return a.value(new Seq([new Ref(b[1])]));switch(b[0]){case"":return a.value(new Seq);case"_*":a.error("`_*' is not supported");break;case"*":return a.value(new Call("quant"));case"#":return a.value(new Call("numf"));default:return a.value(new Call(b[0]))}},parse_arg:function(){for(var a=new Seq,b=this;!b.isEOS();){b=b.match(/[^\[\],~]*(?:~[\[\],~]?[^\[\],~]*)*/g);var c=b.val[0];if(c){var d;if(d=c.match(/^_(-?\d+)$/))a.add(new Ref(d[1]));else{if("_*"===c)throw new SyntaxError("`_*' is not supported");a.add(new Lit(this.unescape(c)))}}switch(b.charAt()){case"[":b=b.parse_bracket(),b.val&&a.add(b.val);break;case",":case"]":return 0===a.seq.length?b.value(new Lit("")):1===a.seq.length?b.value(a.seq[0]):b.value(a)}}b.error("unmatched `['")},unescape:function(a){return String(a).replace(/~([\[\],~])/g,"$1")}};